name: "Link Checker"

on:
  pull_request:
    paths:
      - '00_–ü—Ä–∞–≤–∏–ª–∞_–æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è/**/*.md'
      - '01_–í—Å–µ–ª–µ–Ω–Ω–∞—è/**/*.md'
      - '02_–°—Ç–∞–Ω—Ü–∏—è/**/*.md'
      - '03_–ì–æ—Å—É–¥–∞—Ä—Å—Ç–≤–∞/**/*.md'
      - '04_–ö–æ—Ä–ø–æ—Ä–∞—Ü–∏–∏/**/*.md'
      - '05_–û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏/**/*.md'
      - '06_–†–∞—Å—ã/**/*.md'
      - '07_–°—É—â–µ—Å—Ç–≤–∞/**/*.md'
      - '08_–¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏/**/*.md'
      - '09_–í–æ–æ—Ä—É–∂–µ–Ω–∏–µ/**/*.md'
      - '10_–Ø–≤–ª–µ–Ω–∏—è/**/*.md'
      - '11_–¢–æ–≤–∞—Ä—ã/**/*.md'
      - '12_–î—Ä—É–≥–æ–µ/**/*.md'
      - '13_–ò—Å—Ç–æ—Ä–∏–∏/**/*.md'
      - '14_–ü–æ–≤—Å–µ–¥–Ω–µ–≤–Ω–æ—Å—Ç—å/**/*.md'

jobs:
  link-check:
    runs-on: ubuntu-latest

    steps:
      # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
      - name: Checkout repository
        uses: actions/checkout@v3

      # –£—Å—Ç–∞–Ω–æ–≤–∫–∞ lychee
      - name: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Lychee
        run: cargo install lychee

      # –ó–∞–ø—É—Å–∫ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—Å—ã–ª–æ–∫
      - name: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Å—ã–ª–æ–∫ –≤ Markdown
        id: link-check
        run: lychee --output json --dump ./lychee-output.json "**/*.md" || echo "–û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –ø—Ä–æ–±–ª–µ–º—ã —Å–æ —Å—Å—ã–ª–∫–∞–º–∏."

      # –û—Ç–ø—Ä–∞–≤–∫–∞ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è –∫ PR
      - name: –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∫ PR —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏
        if: always()
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs');
            const outputFile = './lychee-output.json';

            if (!fs.existsSync(outputFile)) {
              github.rest.issues.createComment({
                issue_number: context.payload.pull_request.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –æ—Ç—á–µ—Ç –æ –ø—Ä–æ–≤–µ—Ä–∫–µ —Å—Å—ã–ª–æ–∫. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ Markdown —Ñ–∞–π–ª—ã –¥–æ—Å—Ç—É–ø–Ω—ã –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏.',
              });
              return;
            }

            const output = JSON.parse(fs.readFileSync(outputFile, 'utf8'));
            if (!output.links || output.links.length === 0) {
              github.rest.issues.createComment({
                issue_number: context.payload.pull_request.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: 'üîç –í —Ñ–∞–π–ª–∞—Ö Markdown –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–æ —Å—Å—ã–ª–æ–∫.',
              });
              return;
            }

            const failedLinks = output.links.filter(link => link.status !== 'Ok');
            if (failedLinks.length === 0) {
              github.rest.issues.createComment({
                issue_number: context.payload.pull_request.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: '‚úÖ –í—Å–µ —Å—Å—ã–ª–∫–∏ –≤ —Ñ–∞–π–ª–∞—Ö Markdown –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã!',
              });
              return;
            }

            const errorDetails = failedLinks
              .map(link => `- [${link.uri}](${link.uri}) (–§–∞–π–ª: ${link.source}) ‚Üí –°—Ç–∞—Ç—É—Å: ${link.status}`)
              .join('\n');

            const issueComment = `
              ### –û—Ç—á–µ—Ç –æ –ø—Ä–æ–≤–µ—Ä–∫–µ —Å—Å—ã–ª–æ–∫
              –û–±–Ω–∞—Ä—É–∂–µ–Ω—ã —Å–ª–µ–¥—É—é—â–∏–µ –ø—Ä–æ–±–ª–µ–º—ã —Å–æ —Å—Å—ã–ª–∫–∞–º–∏:

              ${errorDetails}

              –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∏—Å–ø—Ä–∞–≤—å—Ç–µ –∏—Ö –ø–µ—Ä–µ–¥ —Å–ª–∏—è–Ω–∏–µ–º.
            `;

            github.rest.issues.createComment({
              issue_number: context.payload.pull_request.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: issueComment,
            });
